services:
  game-server:
    build:
      context: ./nettygame
    container_name: netty-game-server
    ports:
      - "12345:12345"
    environment:
      HERO_STORY_SERVER_PORT: 12345
      HERO_STORY_MYSQL_ENABLED: "true"
      HERO_STORY_MYSQL_JDBC_URL: "jdbc:mysql://mysql:3306/hero_story?useSSL=false&useUnicode=true&characterEncoding=UTF-8&zeroDateTimeBehavior=convertToNull&autoReconnect=true&autoReconnectForPools=true"
      HERO_STORY_MYSQL_USERNAME: hero
      HERO_STORY_MYSQL_PASSWORD: hero_pass
      HERO_STORY_REDIS_ENABLED: "true"
      HERO_STORY_REDIS_HOST: redis
      HERO_STORY_REDIS_PORT: 6379
      HERO_STORY_ROCKETMQ_ENABLED: "false"
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_started

  mysql:
    image: mysql:8.0
    container_name: netty-game-mysql
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: hero_story
      MYSQL_USER: hero
      MYSQL_PASSWORD: hero_pass
      MYSQL_ROOT_PASSWORD: root_pass
    ports:
      - "3306:3306"
    volumes:
      - ./deploy/mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot_pass --silent"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: netty-game-redis
    ports:
      - "6379:6379"

  rocketmq-namesrv:
    image: apache/rocketmq:5.3.2
    profiles: ["full"]
    container_name: netty-game-rocketmq-namesrv
    command: sh mqnamesrv
    ports:
      - "9876:9876"

  rocketmq-broker:
    image: apache/rocketmq:5.3.2
    profiles: ["full"]
    container_name: netty-game-rocketmq-broker
    command: sh mqbroker -n rocketmq-namesrv:9876 -c /home/rocketmq/rocketmq-5.3.2/conf/broker.conf
    depends_on:
      - rocketmq-namesrv
    ports:
      - "10911:10911"
      - "10909:10909"

  rank-worker:
    build:
      context: ./nettygame
    profiles: ["full"]
    container_name: netty-game-rank-worker
    environment:
      APP_MAIN_CLASS: org.tinygame.herostory.RankApp
      HERO_STORY_REDIS_ENABLED: "true"
      HERO_STORY_REDIS_HOST: redis
      HERO_STORY_REDIS_PORT: 6379
      HERO_STORY_ROCKETMQ_ENABLED: "true"
      HERO_STORY_ROCKETMQ_NAMESRV: rocketmq-namesrv:9876
    depends_on:
      - redis
      - rocketmq-broker

  mysql-it:
    image: mysql:8.0
    profiles: ["integration"]
    container_name: netty-game-it-mysql
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_DATABASE: hero_story
      MYSQL_USER: hero
      MYSQL_PASSWORD: hero_pass
      MYSQL_ROOT_PASSWORD: root_pass
    ports:
      - "3307:3306"
    volumes:
      - ./deploy/mysql/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -uroot -proot_pass --silent"]
      interval: 10s
      timeout: 5s
      retries: 20

  redis-it:
    image: redis:7-alpine
    profiles: ["integration"]
    container_name: netty-game-it-redis
    ports:
      - "6380:6379"
